image: node:24

stages:
  - verify
  - publish

variables:
  HUSKY: "0"
  NPM_CONFIG_CACHE: "$CI_PROJECT_DIR/.npm"

cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - .npm/

verify:
  stage: verify
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG
  script:
    - ./scripts/ci-verify.sh

publish:
  stage: publish
  needs: ["verify"]
  rules:
    - if: $CI_COMMIT_TAG
  id_tokens:
    NPM_ID_TOKEN:
      aud: "npm:registry.npmjs.org"
    SIGSTORE_ID_TOKEN:
      aud: "sigstore"
  script:
    - ./scripts/ci-publish.sh
